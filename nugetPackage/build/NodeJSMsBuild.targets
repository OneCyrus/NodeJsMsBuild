<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="12.0">


<Target Name="FindNPMTools">
  <Exec ContinueOnError="True" Command='npm -v'>
    <Output TaskParameter="ExitCode" PropertyName="NpmErrorCode"/>
 </Exec>
 <Exec ContinueOnError="True" Command='bower -v'>
   <Output TaskParameter="ExitCode" PropertyName="BowerErrorCode"/>
</Exec>
<Exec ContinueOnError="True" Command='tsd -V'>
  <Output TaskParameter="ExitCode" PropertyName="TsdErrorCode"/>
</Exec>


  <PropertyGroup>
    <Npm Condition="$(NpmErrorCode) == 0">npm</Npm>
    <Npm Condition=" '$(Npm)'=='' And $(NpmErrorCode) != 0 ">npm</Npm>
    <Npm Condition=" '$(Npm)'=='' And Exists('$(MSBuildProjectDirectory)/.bin/npm.cmd') ">.bin/npm.cmd</Npm>

    <Bower Condition="$(BowerErrorCode) == 0">bower</Bower>
    <Bower Condition=" '$(Bower)'=='' And Exists('$(MSBuildProjectDirectory)/.bin/bower.cmd') ">.bin/bower.cmd</Bower>
    <Bower Condition=" '$(Bower)'=='' And Exists('$(MSBuildProjectDirectory)/node_modules/.bin/bower') ">node_modules/.bin/bower.cmd</Bower>
    <BowerParam Condition="'$(BowerParam)' == ''">--config.interactive=false</BowerParam>

    <Tsd Condition="$(TsdErrorCode) == 0">tsd</Tsd>
    <Tsd Condition=" '$(Tsd)'=='' And Exists('$(MSBuildProjectDirectory)/.bin/tsd.cmd') ">.bin/tsd.cmd</Tsd>
    <Tsd Condition=" '$(Tsd)'=='' And Exists('$(MSBuildProjectDirectory)/node_modules/.bin/tsd') ">node_modules/.bin/tsd.cmd</Tsd>

  </PropertyGroup>
</Target>

<Target Name="FindTaskTools">
  <Exec ContinueOnError="True" Command='gulp -v'>
    <Output TaskParameter="ExitCode" PropertyName="GulpErrorCode"/>
 </Exec>
 <Exec ContinueOnError="True" Command='grunt -v'>
   <Output TaskParameter="ExitCode" PropertyName="GruntErrorCode"/>
</Exec>
  <PropertyGroup>
    <Gulp Condition="$(GulpErrorCode) == 0">gulp</Gulp>
    <Gulp Condition=" '$(Gulp)'=='' And Exists('$(MSBuildProjectDirectory)/.bin/gulp.cmd') ">.bin/gulp</Gulp>
    <Gulp Condition=" '$(Gulp)'=='' And Exists('$(MSBuildProjectDirectory)/node_modules/.bin/gulp') ">node_modules/.bin/gulp.cmd</Gulp>

    <Grunt Condition="$(GruntErrorCode) == 0">grunt</Grunt>
    <Grunt Condition=" '$(Grunt)'=='' And Exists('$(MSBuildProjectDirectory)/.bin/grunt.cmd') ">.bin/grunt.cmd</Grunt>
    <Grunt Condition=" '$(Grunt)'=='' And Exists('$(MSBuildProjectDirectory)/node_modules/.bin/grunt') ">node_modules/.bin/grunt.cmd</Grunt>
  </PropertyGroup>
</Target>

  <PropertyGroup>
    <CleanDependsOn>
      $(CleanDependsOn);
      CleanNodeJsFiles
    </CleanDependsOn>

    <CleanNodeJsFilesDependsOn>
      $(CleanNodeJsFilesDependsOn);
    </CleanNodeJsFilesDependsOn>
  </PropertyGroup>
  <Target Name="CleanNodeJsFiles" DependsOnTargets="$(CleanNodeJsFilesDependsOn)">
      <ItemGroup>
        <_filesToDelete Remove="@(_filesToDelete)"/>
        <_filesToDelete Include="%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js"
                        Condition="!$([System.String]::new('%(TypeScriptCompile.Filename)').EndsWith('.d')) and Exists('%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js')" />
        <_filesToDelete Include="%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js.map"
                             Condition="!$([System.String]::new('%(TypeScriptCompile.Filename)').EndsWith('.d')) and Exists('%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js.map')" />
    </ItemGroup>

    <Delete Files="@(_filesToDelete)" />
    <RemoveDir Directories="$(MSBuildProjectDirectory)/bower_components/;$(MSBuildProjectDirectory)/typings/"/>
    <Exec Command="DelFolder $(node_modules)" />
  </Target>

  <PropertyGroup>
    <BuildDependsOn>
      RestoreNodeJsPackages;
      $(BuildDependsOn);
      RunJsBuildTasks;
    </BuildDependsOn>

    <RestoreNodeJsPackagesDependsOn>
      $(RestoreNodeJsPackagesDependsOn);
      FindNPMTools;
    </RestoreNodeJsPackagesDependsOn>

    <RunJsBuildTasksDependsOn>
      $(RunJsBuildTasksDependsOn);
      FindTaskTools;
    </RunJsBuildTasksDependsOn>
  </PropertyGroup>

  <Target Name="RestoreNodeJsPackages" DependsOnTargets="$(RestoreNodeJsPackagesDependsOn)">
    <Warning Text="Unable to find npm command line; NodeJS tasks will not be executed" Condition=" '$(Npm)' == '' "/>
    <Exec Command="$(Npm) install" Condition=" '$(Npm)' != '' " />
    <Message Text="Npm packages restored." Condition=" '$(Npm)' != '' "/>
    <Exec Command="$(Tsd) reinstall" Condition=" '$(Tsd)' != '' " />
    <Message Text="Tsd packages restored." Condition=" '$(Tsd)' != '' "/>
    <Exec Command="$(Bower) install $(BowerParam)" Condition=" '$(Bower)' != '' " />
    <Message Text="Bower packages restored." Condition=" '$(Bower)' != '' "/>
  </Target>


  <Target Name="RunJsBuildTasks" DependsOnTargets="$(RunJsBuildTasksDependsOn)">
    <Exec Command="$(Gulp) $(Configuration)" Condition=" '$(Gulp)' != '' " />
    <Message Text="Gulp tasks for ($Configuration) ran." Condition=" '$(Gulp)' != '' "/>
    <Exec Command="$(Grunt) $(Configuration)" Condition=" '$(Grunt)' != '' "/>
    <Message Text="Grunt tasks for ($Configuration) ran." Condition=" '$(Grunt)' != '' "/>
  </Target>

</Project>
