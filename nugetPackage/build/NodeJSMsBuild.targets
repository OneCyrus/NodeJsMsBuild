<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="12.0">


<Target Name="FindNPMTools">
  <Message Text="$(PATH)"/>
  <Exec ContinueOnError="True" Command='npm'>
    <Output TaskParameter="ExitCode" PropertyName="ErrorCode"/>
 </Exec>
 <Exec ContinueOnError="True" Command='bower'>
   <Output TaskParameter="ExitCode" PropertyName="ErrorCode"/>
</Exec>
<Exec ContinueOnError="True" Command='tsd'>
  <Output TaskParameter="ExitCode" PropertyName="ErrorCode"/>
</Exec>

  <PropertyGroup>
    <Npm Condition="ErrorCode == 0">npm</Npm>
    <Npm Condition=" '$(Npm)'=='' And $(ErrorCode) != 0 ">npm</Npm>
    <Npm Condition=" '$(Npm)'=='' And Exists('.bin/npm.cmd') ">.bin/npm.cmd</Npm>

    <Bower Condition="ErrorCode == 0">bower</Bower>
    <Bower Condition=" '$(Bower)'=='' And Exists('.bin/bower.cmd') ">.bin/bower.cmd</Bower>
    <Bower Condition=" '$(Bower)'=='' And Exists('node_modules/.bin/bower') ">node_modules/.bin/bower.cmd</Bower>
    <BowerParam>--config.interactive=false</BowerParam>

    <Tsd Condition="ErrorCode == 0">bower</Tsd>
    <Tsd Condition=" '$(Tsd)'=='' And Exists('.bin/tsd.cmd') ">.bin/tsd.cmd</Tsd>
    <Tsd Condition=" '$(Tsd)'=='' And Exists('node_modules/.bin/tsd') ">node_modules/.bin/tsd.cmd</Tsd>

  </PropertyGroup>
</Target>

<Target Name="FindTaskTools">
  <Exec ContinueOnError="True" Command='gulp'>
    <Output TaskParameter="ExitCode" PropertyName="ErrorCode"/>
 </Exec>
 <Exec ContinueOnError="True" Command='grunt'>
   <Output TaskParameter="ExitCode" PropertyName="ErrorCode"/>
</Exec>
  <PropertyGroup>
    <Gulp Condition="ErrorCode == 0">gulp</Gulp>
    <Gulp Condition=" '$(Gulp)'=='' And Exists('.bin/gulp.cmd') ">.bin/gulp</Gulp>
    <Gulp Condition=" '$(Gulp)'=='' And Exists('node_modules/.bin/gulp') ">node_modules/.bin/gulp.cmd</Gulp>

    <Grunt Condition="ErrorCode == 0">grunt</Grunt>
    <Grunt Condition=" '$(Grunt)'=='' And Exists('.bin/grunt.cmd') ">.bin/grunt.cmd</Grunt>
    <Grunt Condition=" '$(Grunt)'=='' And Exists('node_modules/.bin/grunt') ">node_modules/.bin/grunt.cmd</Grunt>
  </PropertyGroup>
</Target>

  <PropertyGroup>
    <CleanDependsOn>
      $(CleanDependsOn);
      CleanNodeJsFiles
    </CleanDependsOn>

    <CleanNodeJsFilesDependsOn>
      $(CleanNodeJsFilesDependsOn);
    </CleanNodeJsFilesDependsOn>
  </PropertyGroup>
  <Target Name="CleanNodeJsFiles" DependsOnTargets="$(CleanNodeJsFilesDependsOn)">
      <ItemGroup>
        <_filesToDelete Remove="@(_filesToDelete)"/>
        <_filesToDelete Include="%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js"
                        Condition="!$([System.String]::new('%(TypeScriptCompile.Filename)').EndsWith('.d')) and Exists('%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js')" />
        <_filesToDelete Include="%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js.map"
                             Condition="!$([System.String]::new('%(TypeScriptCompile.Filename)').EndsWith('.d')) and Exists('%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js.map')" />
    </ItemGroup>

    <Delete Files="@(_filesToDelete)" />
    <RemoveDir Directories=".\bower_components\;.\typings\"/>
    <Exec Command="DelFolder $(node_modules)" />
  </Target>

  <PropertyGroup>
    <BuildDependsOn>
      RestoreNodeJsPackages;
      $(BuildDependsOn);
      RunJsBuildTasks;
    </BuildDependsOn>

    <RestoreNodeJsPackagesDependsOn>
      $(RestoreNodeJsPackagesDependsOn);
      FindNPMTools;
    </RestoreNodeJsPackagesDependsOn>

    <RunJsBuildTasksDependsOn>
      $(RunJsBuildTasksDependsOn);
      FindTaskTools;
    </RunJsBuildTasksDependsOn>
  </PropertyGroup>

  <Target Name="RestoreNodeJsPackages" DependsOnTargets="$(RestoreNodeJsPackagesDependsOn)">
    <Message Text="
    Npm: $(Npm)
    Bower: $(Bower)
    Grunt: $(Grunt)" Importance="high"/>
    <Warning Text="Unable to find npm command line; NodeJS tasks will not be executed" Condition=" '$(Npm)' == '' "/>
    <Exec Command="$(Npm) install" Condition=" '$(Npm)' != '' " />
    <Message Text="Npm packages restored." Condition=" '$(Tsd)' != '' "/>
    <Exec Command="$(Tsd) reinstall" Condition=" '$(Tsd)' != '' " />
    <Message Text="Tsd packages restored." Condition=" '$(Npm)' != '' "/>
    <Exec Command="$(Bower) install $(BowerParam)" Condition=" '$(Bower)' != '' " />
    <Message Text="Bower packages restored." Condition=" '$(Bower)' != '' "/>
  </Target>


  <Target Name="RunJsBuildTasks" DependsOnTargets="$(RunJsBuildTasksDependsOn)">

    <Exec Command="$(Gulp) $(Configuration)" Condition=" '$(Gulp)' != '' " />
    <Message Text="Gulp tasks for ($Configuration) ran." Condition=" '$(Gulp)' != '' "/>
    <Exec Command="$(Grunt) $(Configuration)" Condition=" '$(Grunt)' != '' "/>
    <Message Text="Grunt tasks for ($Configuration) ran." Condition=" '$(Grunt)' != '' "/>
  </Target>

</Project>
