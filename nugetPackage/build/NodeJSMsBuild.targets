<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="12.0">


<Target Name="FindTools">
  <PropertyGroup>
    <Npm Condition=" '$(Npm)'=='' And Exists('npm') ">npm</Npm>
    <Npm Condition=" '$(Npm)'=='' And Exists('.bin/npm') ">.bin/npm</Npm>

    <Bower Condition=" '$(Bower)'=='' And Exists('bower') ">bower</Bower>
    <Bower Condition=" '$(Bower)'=='' And Exists('.bin/bower') ">.bin/bower</Bower>
    <Bower Condition=" '$(Bower)'=='' And Exists('node_modules/.bin/bower') ">node_modules/.bin/bower</Bower>

    <Tsd Condition=" '$(Tsd)'=='' And Exists('tsd') ">tsd</Tsd>
    <Tsd Condition=" '$(Tsd)'=='' And Exists('.bin/tsd') ">.bin/tsd</Tsd>
    <Tsd Condition=" '$(Tsd)'=='' And Exists('node_modules/.bin/tsd') ">node_modules/.bin/tsd</Tsd>

    <Gulp Condition=" '$(Gulp)'=='' And Exists('gulp') ">gulp</Gulp>
    <Gulp Condition=" '$(Gulp)'=='' And Exists('.bin/gulp') ">.bin/gulp</Gulp>
    <Gulp Condition=" '$(Gulp)'=='' And Exists('node_modules/.bin/gulp') ">node_modules/.bin/gulp</Gulp>

    <Grunt Condition=" '$(Grunt)'=='' And Exists('gulp') ">gulp</Grunt>
    <Grunt Condition=" '$(Grunt)'=='' And Exists('.bin/gulp') ">.bin/gulp</Grunt>
    <Grunt Condition=" '$(Grunt)'=='' And Exists('node_modules/.bin/gulp') ">node_modules/.bin/gulp</Grunt>
  </PropertyGroup>
</Target>

  <PropertyGroup>
    <CleanDependsOn>
      $(CleanDependsOn);
      CleanNodeJsFiles
    </CleanDependsOn>

    <CleanNodeJsFilesDependsOn>
      $(CleanNodeJsFilesDependsOn);
    </CleanNodeJsFilesDependsOn>
  </PropertyGroup>
  <Target Name="CleanNodeJsFiles" DependsOnTargets="$(CleanNodeJsFilesDependsOn)">
      <ItemGroup>
        <_filesToDelete Remove="@(_filesToDelete)"/>
        <_filesToDelete Include="%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js"
                        Condition="!$([System.String]::new('%(TypeScriptCompile.Filename)').EndsWith('.d')) and Exists('%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js')" />
        <_filesToDelete Include="%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js.map"
                             Condition="!$([System.String]::new('%(TypeScriptCompile.Filename)').EndsWith('.d')) and Exists('%(TypeScriptCompile.RelativeDir)%(TypeScriptCompile.Filename).js.map')" />
    </ItemGroup>

    <Delete Files="@(_filesToDelete)" />
    <RemoveDir Directories=".\bower_components\;.\typings\"/>
    <Exec Command="DelFolder $(node_modules)" />
  </Target>

  <PropertyGroup>
    <BuildDependsOn>
      RestoreNodeJsPackages;
      $(BuildDependsOn);
      RunJsBuildTasks;
    </BuildDependsOn>

    <RestoreNodeJsPackagesDependsOn>
      $(RestoreNodeJsPackagesDependsOn);
    </RestoreNodeJsPackagesDependsOn>

    <RunJsBuildTasksDependsOn>
      $(RunJsBuildTasksDependsOn);
      FindTools;
    </RunJsBuildTasksDependsOn>
  </PropertyGroup>

  <Target Name="RestoreNodeJsPackages" DependsOnTargets="$(RestoreNodeJsPackagesDependsOn)">
    <Message Text="
    Npm: $(Npm)
    Bower: $(Bower)
    Grunt: $(Grunt)" Importance="high"/>
    <Warning Text="Unable to find npm command line; NodeJS tasks will not be executed" Condition=" '$(Npm)' == '' "/>
    <Exec Command="$(Npm) install" Condition=" '$(Npm)' != '' " />
    <Message Text="Npm packages restored." Condition=" '$(Tsd)' != '' "/>
    <Exec Command="$(Tsd) reinstall" Condition=" '$(Tsd)' != '' " />
    <Message Text="Tsd packages restored." Condition=" '$(Npm)' != '' "/>
    <Exec Command="$(Bower) install $(BowerParam)" Condition=" '$(Bower)' != '' " />
    <Message Text="Bower packages restored." Condition=" '$(Bower)' != '' "/>
  </Target>


  <Target Name="RunJsBuildTasks" DependsOnTargets="$(RunJsBuildTasksDependsOn)">

    <Exec Command="$(Gulp) $(Configuration)" Condition=" '$(Gulp)' != '' " />
    <Message Text="Gulp tasks for ($Configuration) ran." Condition=" '$(Gulp)' != '' "/>
    <Exec Command="$(Grunt) $(Configuration)" Condition="$(Grunt) != '' "/>
    <Message Text="Grunt tasks for ($Configuration) ran." Condition=" '$(Grunt)' != '' "/>
  </Target>

</Project>
